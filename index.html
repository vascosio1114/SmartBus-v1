<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Minibus: Full Ecosystem Demo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #F1F5F9; }
        
        /* Map Styles */
        .stop-marker {
            background-color: #CBD5E1; border: 2px solid #64748B; border-radius: 50%; width: 12px; height: 12px; transition: all 0.3s ease;
        }
        .stop-marker.active {
            background-color: #F59E0B; border-color: #B45309; transform: scale(1.5); box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .vehicle-marker {
            font-size: 24px; color: #2563EB; text-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            transition: all 15s linear; 
            z-index: 1000;
        }

        /* App Screens */
        .phone-wrapper {
            perspective: 1000px;
            margin: 0 10px;
        }
        .phone-screen {
            background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border: 6px solid #1E293B;
            height: 550px; width: 300px; display: flex; flex-direction: column; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        .phone-screen:hover {
            transform: translateY(-5px);
        }
        
        .driver-screen {
            background: #1e293b; color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            height: 600px; max-width: 100%; display: flex; flex-direction: column;
        }

        /* Animations */
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        
        @keyframes fadeInOut { 
            0% { opacity: 0; transform: translateY(-10px); } 
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .toast-msg { animation: fadeInOut 3s forwards; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Scrollbar hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Role Switcher (Top Bar) -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-center md:justify-between h-16 items-center">
                <div class="hidden md:flex items-center font-bold text-slate-800 text-lg">
                    <i class="fa-solid fa-layer-group text-blue-600 mr-2"></i> Smart Minibus Ecosystem
                </div>
                
                <!-- Role Tabs -->
                <div class="flex space-x-2 bg-slate-100 p-1 rounded-lg">
                    <button onclick="switchRole('passenger')" id="tab-passenger" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900">
                        <i class="fa-solid fa-users mr-1"></i> 乘客 (x3)
                    </button>
                    <button onclick="switchRole('driver')" id="tab-driver" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900">
                        <i class="fa-solid fa-steering-wheel mr-1"></i> 司機 App
                    </button>
                    <button onclick="switchRole('system')" id="tab-system" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-white shadow text-blue-600">
                        <i class="fa-solid fa-desktop mr-1"></i> 系統後台
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full overflow-hidden">

        <!-- VIEW 1: PASSENGERS APP (Multi-Instance) -->
        <div id="view-passenger" class="tab-content">
            
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">多人模擬測試</h2>
                <p class="text-slate-500 text-sm">同時操作 3 位不同位置的乘客，測試系統的共乘邏輯。</p>
            </div>

            <!-- Phones Container -->
            <div class="flex flex-wrap justify-center gap-6 overflow-x-auto pb-8" id="phones-container">
                <!-- Phone 1: Amy -->
                <!-- Phone 2: Ben -->
                <!-- Phone 3: Cat -->
                <!-- (Generated by JS) -->
            </div>

            <div class="text-center mt-4 text-slate-500 text-sm">
                <button onclick="resetSimulation()" class="bg-white border border-slate-300 px-4 py-2 rounded-lg text-xs hover:bg-slate-50">
                    <i class="fa-solid fa-rotate-right mr-1"></i> 全局重置 (Global Reset)
                </button>
            </div>
        </div>

        <!-- VIEW 2: DRIVER APP -->
        <div id="view-driver" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                <!-- Left Panel: Large Instructions -->
                <div class="lg:col-span-2 driver-screen p-6 relative">
                    <div class="absolute top-4 right-4 flex items-center space-x-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-xs font-mono text-green-400">ONLINE</span>
                    </div>

                    <div class="flex-grow flex flex-col justify-center items-center text-center">
                        <div class="text-slate-400 text-sm uppercase tracking-widest mb-2">Next Action</div>
                        <div id="driver-action-icon" class="text-6xl mb-4 text-blue-400">
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                        <h1 id="driver-action-text" class="text-5xl font-bold mb-2">Proceed</h1>
                        <p id="driver-target-stop" class="text-2xl text-slate-300">to Tsim Sha Tsui</p>
                    </div>

                    <div class="mt-auto bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400">Capacity</span>
                            <span class="font-bold text-xl"><span id="driver-pax-count" class="text-white">0</span> <span class="text-slate-500">/ 16</span></span>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Order List -->
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden flex flex-col h-full shadow-lg">
                    <div class="bg-slate-50 p-4 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800"><i class="fa-solid fa-list-ul mr-2"></i>任務列表 (Manifest)</h3>
                    </div>
                    <div id="driver-manifest" class="flex-grow overflow-y-auto p-2 space-y-2 bg-slate-50">
                        <div class="text-center text-slate-400 text-sm mt-10 italic">暫無訂單 (Waiting for orders...)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: SYSTEM (GOD VIEW) -->
        <div id="view-system" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Map -->
                <div class="lg:col-span-2 bg-white p-1 rounded-xl shadow-md border border-slate-200 h-[600px] relative z-0">
                    <div id="map" class="w-full h-full rounded-lg z-0"></div>
                    
                    <!-- Quick Actions Overlay -->
                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-slate-200 z-[1000]">
                        <button onclick="resetSimulation()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs py-2 px-3 rounded-md transition-colors">
                            <i class="fa-solid fa-rotate-right mr-1"></i> 重置所有
                        </button>
                    </div>

                    <!-- Overlay Legend -->
                    <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-lg shadow-lg border border-slate-200 z-[1000]">
                        <div class="text-xs font-bold text-slate-500 mb-1">LEGEND</div>
                        <div class="flex items-center space-x-3 text-xs">
                            <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-blue-600 mr-1"></div> Vehicle</div>
                            <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-amber-500 mr-1"></div> Pickup</div>
                            <div class="flex items-center"><div class="w-2 h-2 rounded-full bg-slate-300 border border-slate-500 mr-1"></div> Stop</div>
                        </div>
                    </div>
                </div>

                <!-- Logs & Data -->
                <div class="space-y-4 h-[600px] flex flex-col">
                    <!-- System Log -->
                    <div class="bg-slate-900 rounded-xl shadow-lg border border-slate-800 p-4 flex-grow overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h4 class="font-bold text-xs text-emerald-400 font-mono"><i class="fa-solid fa-terminal mr-2"></i>SYSTEM_LOG</h4>
                            <span class="text-[10px] text-slate-500 animate-pulse">● LIVE</span>
                        </div>
                        <div id="system-log" class="font-mono text-xs overflow-y-auto space-y-1 text-slate-300 pr-2 h-full">
                            <div class="text-slate-500">System initialized...</div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-1/4">
                         <h4 class="font-bold text-xs text-slate-700 mb-2">REAL-TIME METRICS</h4>
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <div class="text-2xl font-bold text-slate-800" id="total-orders">0</div>
                                 <div class="text-[10px] text-slate-500">Total Orders</div>
                             </div>
                             <div>
                                <div class="text-2xl font-bold text-emerald-600" id="active-pax-sys">0</div>
                                <div class="text-[10px] text-slate-500">Onboard</div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- 1. CONFIG & DATA ---
        const stops = [
            { id: 0, name: "尖沙咀碼頭 (Star Ferry)", lat: 22.2935, lng: 114.1695 },
            { id: 1, name: "半島酒店 (Peninsula)", lat: 22.2952, lng: 114.1720 },
            { id: 2, name: "海防道 (Haiphong Rd)", lat: 22.2975, lng: 114.1722 },
            { id: 3, name: "柯士甸道 (Austin Rd)", lat: 22.3025, lng: 114.1718 },
            { id: 4, name: "佐敦站 (Jordan Stn)", lat: 22.3048, lng: 114.1715 },
            { id: 5, name: "寧波街 (Ning Po St)", lat: 22.3080, lng: 114.1710 },
            { id: 6, name: "眾坊街 (Public Square)", lat: 22.3105, lng: 114.1708 },
            { id: 7, name: "油麻地站 (YMT Stn)", lat: 22.3130, lng: 114.1705 },
            { id: 8, name: "登打士街 (Dundas St)", lat: 22.3155, lng: 114.1702 },
            { id: 9, name: "山東街 (Shantung St)", lat: 22.3175, lng: 114.1700 },
            { id: 10, name: "旺角站 (Mong Kok Stn)", lat: 22.3195, lng: 114.1695 },
            { id: 11, name: "亞皆老街 (Argyle St)", lat: 22.3215, lng: 114.1692 },
            { id: 12, name: "太子站 (Prince Edward)", lat: 22.3240, lng: 114.1688 }
        ];

        // --- 2. GLOBAL STATE ---
        const state = {
            activeRole: 'system',
            vehicle: {
                currentStopIndex: 0,
                status: 'idle', 
                passengers: 0,
                capacity: 16
            },
            orders: [],
            // Multiple simulated passengers
            passengers: [
                { id: 0, name: "Amy", color: "blue", orderId: null, defaultFrom: 0, defaultTo: 4 },
                { id: 1, name: "Ben", color: "emerald", orderId: null, defaultFrom: 4, defaultTo: 10 },
                { id: 2, name: "Cat", color: "violet", orderId: null, defaultFrom: 7, defaultTo: 12 }
            ],
            simSpeed: 1000,
            isMoving: false,
            stopsSkipped: 0
        };

        // --- 3. MAP INIT ---
        const map = L.map('map').setView([22.309, 114.1705], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        const createStopIcon = (isActive) => L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="stop-marker ${isActive ? 'active' : ''}"></div>`,
            iconSize: [12, 12], iconAnchor: [6, 6]
        });

        const vehicleIcon = L.divIcon({
            className: 'custom-div-icon',
            html: `<i class="fa-solid fa-van-shuttle vehicle-marker"></i>`,
            iconSize: [24, 24], iconAnchor: [12, 12]
        });

        L.polygon([
            [22.2930, 114.1685], [22.3250, 114.1678], 
            [22.3250, 114.1700], [22.2930, 114.1730]
        ], { color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.1, weight: 1, dashArray: '5, 5' }).addTo(map);

        const stopMarkers = {};
        stops.forEach(stop => {
            stopMarkers[stop.id] = L.marker([stop.lat, stop.lng], { icon: createStopIcon(false) }).addTo(map)
                .bindPopup(stop.name);
        });
        const vehicleMarker = L.marker([stops[0].lat, stops[0].lng], { icon: vehicleIcon }).addTo(map);

        // --- 4. UI FUNCTIONS ---

        function initPhoneInterfaces() {
            const container = document.getElementById('phones-container');
            container.innerHTML = ''; // Clear

            state.passengers.forEach((pax, index) => {
                const colorClass = pax.color === 'blue' ? 'bg-blue-600' : (pax.color === 'emerald' ? 'bg-emerald-600' : 'bg-violet-600');
                const lightBg = pax.color === 'blue' ? 'bg-blue-50' : (pax.color === 'emerald' ? 'bg-emerald-50' : 'bg-violet-50');
                const textCol = pax.color === 'blue' ? 'text-blue-600' : (pax.color === 'emerald' ? 'text-emerald-600' : 'text-violet-600');

                // Generate Options HTML
                let optionsHtml = '';
                stops.forEach(s => optionsHtml += `<option value="${s.id}">${s.name}</option>`);

                const phoneHtml = `
                <div class="phone-wrapper">
                    <div class="phone-screen relative">
                        <!-- Toast -->
                        <div id="pax-toast-${index}" class="absolute top-16 left-0 right-0 z-50 px-4 pointer-events-none"></div>

                        <!-- Header -->
                        <div class="bg-white border-b p-4 pt-6 flex justify-between items-center z-10">
                            <div class="font-bold text-lg text-slate-800">SmartRide</div>
                            <div class="flex items-center space-x-2">
                                <span class="text-[10px] ${lightBg} ${textCol} px-2 py-1 rounded font-bold">
                                    <i class="fa-solid fa-user"></i> ${pax.name}
                                </span>
                            </div>
                        </div>
                        <div class="bg-slate-100 px-4 py-1 flex justify-between items-center text-[10px] text-slate-500">
                             <span id="pax-vehicle-loc-${index}">车在: 尖沙咀</span>
                        </div>

                        <!-- Content -->
                        <div class="flex-grow p-4 bg-slate-50 overflow-y-auto no-scrollbar">
                            
                            <!-- FORM -->
                            <div id="pax-booking-form-${index}" class="space-y-4">
                                <div class="${colorClass} text-white p-5 rounded-2xl shadow-lg mb-4">
                                    <h2 class="text-lg font-bold mb-1">去邊度？</h2>
                                    <p class="text-white/80 text-xs">Where to next, ${pax.name}?</p>
                                </div>
                                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 space-y-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">From</label>
                                        <select id="pax-from-${index}" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700">${optionsHtml}</select>
                                    </div>
                                    <div class="flex justify-center -my-2 relative z-10">
                                        <div class="bg-slate-200 rounded-full p-1 border-2 border-white"><i class="fa-solid fa-arrow-down text-slate-500 text-[10px]"></i></div>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">To</label>
                                        <select id="pax-to-${index}" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700">${optionsHtml}</select>
                                    </div>
                                </div>
                                <button id="btn-call-${index}" onclick="submitBooking(${index})" class="w-full ${colorClass} hover:opacity-90 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95 text-sm">
                                    召喚小巴
                                </button>
                            </div>

                            <!-- ACTIVE TRIP -->
                            <div id="pax-active-trip-${index}" class="hidden h-full flex flex-col">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-3 animate-slide-in">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <div class="text-[10px] text-slate-500 uppercase font-bold">Status</div>
                                            <div id="pax-status-text-${index}" class="text-lg font-bold ${textCol}">尋找中...</div>
                                        </div>
                                        <div class="${lightBg} p-2 rounded-full ${textCol} animate-pulse">
                                            <i class="fa-solid fa-satellite-dish"></i>
                                        </div>
                                    </div>
                                    <div class="space-y-3 relative">
                                        <div class="absolute left-2.5 top-2 bottom-2 w-0.5 bg-slate-200"></div>
                                        <div class="flex items-center relative z-10">
                                            <div class="w-5 h-5 rounded-full bg-green-500 border-2 border-white shadow-sm flex items-center justify-center text-white text-[8px] mr-2"><i class="fa-solid fa-location-dot"></i></div>
                                            <div><div class="text-[8px] text-slate-400">PICK UP</div><div id="ticket-from-${index}" class="text-xs font-bold text-slate-800">---</div></div>
                                        </div>
                                        <div class="flex items-center relative z-10">
                                            <div class="w-5 h-5 rounded-full bg-red-500 border-2 border-white shadow-sm flex items-center justify-center text-white text-[8px] mr-2"><i class="fa-solid fa-flag-checkered"></i></div>
                                            <div><div class="text-[8px] text-slate-400">DROP OFF</div><div id="ticket-to-${index}" class="text-xs font-bold text-slate-800">---</div></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-3 animate-slide-in flex-grow">
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-400 mb-1">VEHICLE DISTANCE</div>
                                        <div id="pax-eta-${index}" class="text-2xl font-bold text-slate-800 mb-1">--</div>
                                        <div class="text-[10px] text-slate-500">stops away</div>
                                    </div>
                                </div>

                                <button onclick="cancelBooking(${index})" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-300 text-sm">取消</button>
                            </div>
                        </div>
                        
                         <!-- Nav -->
                        <div class="bg-white border-t p-3 flex justify-around text-slate-400 text-lg">
                            <i class="fa-solid fa-house ${textCol}"></i>
                            <i class="fa-solid fa-clock-rotate-left"></i>
                            <i class="fa-solid fa-gear"></i>
                        </div>
                    </div>
                </div>`;
                
                container.insertAdjacentHTML('beforeend', phoneHtml);
                
                // Set Defaults
                document.getElementById(`pax-from-${index}`).value = pax.defaultFrom;
                document.getElementById(`pax-to-${index}`).value = pax.defaultTo;
            });
        }

        function switchRole(role) {
            state.activeRole = role;
            ['passenger', 'driver', 'system'].forEach(r => {
                const btn = document.getElementById(`tab-${r}`);
                const view = document.getElementById(`view-${r}`);
                if (r === role) {
                    btn.className = "px-4 py-2 rounded-md text-sm font-medium transition-all bg-white shadow text-blue-600";
                    view.classList.add('active');
                } else {
                    btn.className = "px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900";
                    view.classList.remove('active');
                }
            });
            if (role === 'system') setTimeout(() => map.invalidateSize(), 100);
            if (role === 'passenger') renderPassengerApps();
        }

        function log(msg, type='info') {
            const panel = document.getElementById('system-log');
            const color = type === 'alert' ? 'text-amber-400' : (type === 'success' ? 'text-green-400' : 'text-slate-400');
            const entry = `<div class="mb-1"><span class="text-slate-600">[${new Date().toLocaleTimeString('en-US',{hour12:false})}]</span> <span class="${color}">${msg}</span></div>`;
            panel.insertAdjacentHTML('beforeend', entry);
            panel.scrollTop = panel.scrollHeight;
        }

        // --- 5. MULTI-PASSENGER LOGIC ---

        function showPaxToast(index, msg, isError = false) {
            const container = document.getElementById(`pax-toast-${index}`);
            const div = document.createElement('div');
            div.className = `toast-msg shadow-lg rounded-lg px-3 py-2 mb-2 flex items-center ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            div.innerHTML = `<i class="fa-solid ${isError ? 'fa-circle-exclamation' : 'fa-check-circle'} mr-2"></i> <span class="text-xs font-medium">${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function submitBooking(paxIndex) {
            const fromId = parseInt(document.getElementById(`pax-from-${paxIndex}`).value);
            const toId = parseInt(document.getElementById(`pax-to-${paxIndex}`).value);

            if (fromId === toId) return showPaxToast(paxIndex, "起點終點相同", true);
            if (state.vehicle.currentStopIndex >= stops.length - 1) return showPaxToast(paxIndex, "服務已結束", true);
            if (fromId <= state.vehicle.currentStopIndex) return showPaxToast(paxIndex, "車輛已過此站", true);

            const newOrder = {
                id: Date.now() + paxIndex, // Unique-ish
                paxIndex: paxIndex,
                paxName: state.passengers[paxIndex].name,
                from: fromId,
                to: toId,
                status: 'waiting'
            };

            state.orders.push(newOrder);
            state.passengers[paxIndex].orderId = newOrder.id;
            
            stopMarkers[fromId].setIcon(createStopIcon(true));
            log(`New Order: ${state.passengers[paxIndex].name} @ ${stops[fromId].name}`, 'alert');
            showPaxToast(paxIndex, "預約成功！");
            
            renderPassengerApps();
            renderDriverApp();
        }

        function cancelBooking(paxIndex) {
            const orderId = state.passengers[paxIndex].orderId;
            const order = state.orders.find(o => o.id === orderId);
            if (order) {
                // Remove stop marker if it was a pickup waiting
                if (order.status === 'waiting') {
                    // Check if anyone else waiting there
                    const others = state.orders.filter(o => o.from === order.from && o.id !== orderId && o.status === 'waiting');
                    if (others.length === 0) stopMarkers[order.from].setIcon(createStopIcon(false));
                }
                state.orders = state.orders.filter(o => o.id !== orderId);
            }
            state.passengers[paxIndex].orderId = null;
            renderPassengerApps();
            renderDriverApp();
        }

        function renderPassengerApps() {
            // Update Vehicle Location for all
            const currentStopName = stops[state.vehicle.currentStopIndex].name.split(' ')[0];
            const isTerminus = state.vehicle.currentStopIndex >= stops.length - 1;

            state.passengers.forEach((pax, i) => {
                const locEl = document.getElementById(`pax-vehicle-loc-${i}`);
                const btn = document.getElementById(`btn-call-${i}`);
                const form = document.getElementById(`pax-booking-form-${i}`);
                const active = document.getElementById(`pax-active-trip-${i}`);

                locEl.textContent = isTerminus ? "服務結束" : `車在: ${currentStopName}`;
                
                if (isTerminus) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                if (!pax.orderId) {
                    form.classList.remove('hidden');
                    active.classList.add('hidden');
                } else {
                    const order = state.orders.find(o => o.id === pax.orderId);
                    if (!order) { pax.orderId = null; renderPassengerApps(); return; }

                    form.classList.add('hidden');
                    active.classList.remove('hidden');

                    document.getElementById(`ticket-from-${i}`).textContent = stops[order.from].name;
                    document.getElementById(`ticket-to-${i}`).textContent = stops[order.to].name;

                    const statusEl = document.getElementById(`pax-status-text-${i}`);
                    const etaEl = document.getElementById(`pax-eta-${i}`);
                    
                    if (order.status === 'waiting') {
                        const stopsAway = order.from - state.vehicle.currentStopIndex;
                        statusEl.textContent = "車輛前往中";
                        statusEl.className = "text-lg font-bold text-blue-600";
                        etaEl.textContent = stopsAway > 0 ? stopsAway : "即將到達";
                    } else if (order.status === 'onboard') {
                        const stopsToGo = order.to - state.vehicle.currentStopIndex;
                        statusEl.textContent = "行程中";
                        statusEl.className = "text-lg font-bold text-green-600";
                        etaEl.textContent = stopsToGo;
                    } else if (order.status === 'completed') {
                        statusEl.textContent = "已到達";
                        etaEl.textContent = "0";
                    }
                }
            });
        }

        // --- 6. DRIVER & SIMULATION LOOP ---

        function renderDriverApp() {
            const list = document.getElementById('driver-manifest');
            list.innerHTML = "";
            
            if (state.orders.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm mt-10 italic">暫無訂單 (Waiting for orders...)</div>`;
            } else {
                state.orders.forEach(order => {
                    if (order.status === 'completed') return;
                    const item = document.createElement('div');
                    item.className = "bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center";
                    let badge = order.status === 'waiting' 
                        ? `<span class="bg-amber-100 text-amber-700 text-[10px] px-2 py-1 rounded font-bold">PICKUP</span>`
                        : `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded font-bold">DROPOFF</span>`;
                    let targetStopId = order.status === 'waiting' ? order.from : order.to;
                    let text = `Stop ${targetStopId}: ${stops[targetStopId].name}`;
                    
                    item.innerHTML = `
                        <div class="flex-grow">
                            ${badge} <span class="text-[10px] bg-slate-100 px-1 rounded ml-1 font-bold text-slate-500">${order.paxName}</span>
                            <div class="text-sm font-bold mt-1 text-slate-700 truncate w-48">${text}</div>
                        </div>`;
                    list.appendChild(item);
                });
            }

            const nextIndex = state.vehicle.currentStopIndex + 1;
            if (nextIndex < stops.length) {
                const nextStop = stops[nextIndex];
                document.getElementById('driver-target-stop').textContent = `to ${nextStop.name.split(' ')[0]}`;
                
                const pickup = state.orders.some(o => o.from === nextStop.id && o.status === 'waiting');
                const dropoff = state.orders.some(o => o.to === nextStop.id && o.status === 'onboard');
                
                const actionIcon = document.getElementById('driver-action-icon');
                const actionText = document.getElementById('driver-action-text');
                const screen = document.querySelector('.driver-screen');

                if (pickup || dropoff) {
                    actionIcon.innerHTML = `<i class="fa-solid fa-hand-paper"></i>`;
                    actionIcon.className = "text-6xl mb-4 text-amber-400 animate-bounce";
                    actionText.textContent = "STOP";
                    actionText.className = "text-5xl font-bold mb-2 text-amber-400";
                    screen.style.borderColor = "#F59E0B";
                } else {
                    actionIcon.innerHTML = `<i class="fa-solid fa-arrow-right"></i>`;
                    actionIcon.className = "text-6xl mb-4 text-blue-400";
                    actionText.textContent = "SKIP";
                    actionText.className = "text-5xl font-bold mb-2 text-white";
                    screen.style.borderColor = "#1E293B";
                }
            } else {
                document.getElementById('driver-action-text').textContent = "Terminus";
            }
            document.getElementById('driver-pax-count').textContent = state.vehicle.passengers;
        }

        function moveVehicle() {
            if (state.vehicle.currentStopIndex >= stops.length - 1) {
                if(state.isMoving) log("Route Completed.", 'success');
                state.isMoving = false;
                renderPassengerApps();
                return;
            }

            state.isMoving = true;
            const nextIndex = state.vehicle.currentStopIndex + 1;
            const nextStop = stops[nextIndex];
            
            const pickups = state.orders.filter(o => o.from === nextStop.id && o.status === 'waiting');
            const dropoffs = state.orders.filter(o => o.to === nextStop.id && o.status === 'onboard');
            let shouldStop = (pickups.length > 0 || dropoffs.length > 0);
            
            vehicleMarker.setLatLng([nextStop.lat, nextStop.lng]);
            state.vehicle.currentStopIndex = nextIndex;

            const travelTime = 15000;
            const stopTime = 5000;
            const skipDuration = 1000;
            
            if (shouldStop) {
                log(`STOPPING at ${nextStop.name}`, 'info');
                pickups.forEach(o => {
                    o.status = 'onboard';
                    state.vehicle.passengers++;
                    // Only clear marker if no one else is waiting there
                    const others = state.orders.filter(other => other.from === nextStop.id && other.status === 'waiting' && other.id !== o.id);
                    if(others.length === 0) stopMarkers[o.from].setIcon(createStopIcon(false));
                });
                dropoffs.forEach(o => {
                    o.status = 'completed';
                    state.vehicle.passengers--;
                });
                setTimeout(moveVehicle, travelTime + stopTime);
            } else {
                log(`SKIPPING ${nextStop.name}`, 'info');
                state.stopsSkipped++;
                setTimeout(moveVehicle, travelTime + skipDuration);
            }
            
            renderPassengerApps();
            renderDriverApp();
            document.getElementById('total-orders').textContent = state.orders.length;
            document.getElementById('active-pax-sys').textContent = state.vehicle.passengers;
        }

        function resetSimulation() {
            state.vehicle.currentStopIndex = 0;
            state.vehicle.passengers = 0;
            state.orders = [];
            state.passengers.forEach(p => p.orderId = null);
            state.isMoving = false;
            
            vehicleMarker.setLatLng([stops[0].lat, stops[0].lng]);
            stops.forEach(s => stopMarkers[s.id].setIcon(createStopIcon(false)));
            
            renderPassengerApps();
            renderDriverApp();
            log("System Reset.", 'alert');
            
            setTimeout(moveVehicle, 1000);
        }

        // Boot
        initPhoneInterfaces();
        setTimeout(moveVehicle, 2000);

    </script>
</body>
</html>
